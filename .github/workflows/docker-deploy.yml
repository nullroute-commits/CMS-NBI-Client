name: Docker Deploy

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3.6.0
    
    - name: Set up QEMU
      uses: docker/setup-qemu-action@68827325e0b33c7199eb31dd4e31fbe9023e06e3 # v3.0.0
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1
      with:
        version: v0.12.0  # Latest stable as of Dec 2024
    
    - name: Log in to Docker Hub
      uses: docker/login-action@343f7c4344506bcbf9b4de18042ae17996df046d # v3.0.0
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@343f7c4344506bcbf9b4de18042ae17996df046d # v3.0.0
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@dbef88086f6cef02e264edb7dbf63250c17cef6c # v5.5.0
      with:
        images: |
          ${{ secrets.DOCKER_USERNAME }}/cms-nbi-client
          ghcr.io/${{ github.repository }}
        tags: |
          type=ref,event=branch
          type=ref,event=tag
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=raw,value=latest,enable={{is_default_branch}}
    
    - name: Build and push production image
      uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
      with:
        context: .
        file: ./Dockerfile
        platforms: linux/amd64,linux/arm64,linux/arm/v7
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          VERSION=${{ github.ref_name }}
          BUILD_DATE=${{ github.event.head_commit.timestamp }}
          VCS_REF=${{ github.sha }}

  deploy-staging:
    if: github.event.inputs.environment == 'staging' || github.event_name == 'push'
    needs: build-and-push
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
    - uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3.6.0
    
    - name: Deploy to staging
      env:
        DEPLOY_HOST: ${{ secrets.STAGING_HOST }}
        DEPLOY_USER: ${{ secrets.STAGING_USER }}
        DEPLOY_KEY: ${{ secrets.STAGING_SSH_KEY }}
      run: |
        # Setup SSH
        mkdir -p ~/.ssh
        echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        
        # Copy docker compose files
        scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
          docker compose.prod.yml \
          $DEPLOY_USER@$DEPLOY_HOST:/opt/cms-nbi-client/
        
        # Deploy using docker compose
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
          $DEPLOY_USER@$DEPLOY_HOST << 'EOF'
          cd /opt/cms-nbi-client
          export VERSION=${{ github.ref_name }}
          docker compose -f docker compose.prod.yml pull
          docker compose -f docker compose.prod.yml up -d
          docker system prune -f
        EOF

  deploy-production:
    if: github.event.inputs.environment == 'production' && startsWith(github.ref, 'refs/tags/v')
    needs: build-and-push
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3.6.0
    
    - name: Deploy to production
      env:
        DEPLOY_HOST: ${{ secrets.PROD_HOST }}
        DEPLOY_USER: ${{ secrets.PROD_USER }}
        DEPLOY_KEY: ${{ secrets.PROD_SSH_KEY }}
      run: |
        # Setup SSH
        mkdir -p ~/.ssh
        echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        
        # Copy docker compose files
        scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
          docker compose.prod.yml \
          $DEPLOY_USER@$DEPLOY_HOST:/opt/cms-nbi-client/
        
        # Deploy using docker compose with zero downtime
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
          $DEPLOY_USER@$DEPLOY_HOST << 'EOF'
          cd /opt/cms-nbi-client
          export VERSION=${{ github.ref_name }}
          
          # Pull new images
          docker compose -f docker compose.prod.yml pull
          
          # Start new containers alongside old ones
          docker compose -f docker compose.prod.yml up -d --no-deps --scale app=2 app
          
          # Wait for health checks
          sleep 30
          
          # Remove old containers
          docker compose -f docker compose.prod.yml up -d --no-deps --remove-orphans app
          
          # Cleanup
          docker system prune -f
        EOF
    
    - name: Verify deployment
      run: |
        # Add deployment verification logic here
        echo "Deployment completed successfully"